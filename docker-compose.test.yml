# Docker Compose override for test environment
# Usage: docker compose -f docker-compose.yml -f docker-compose.test.yml up

version: "3.9"

services:
  postgres:
    environment:
      POSTGRES_DB: civitas_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"  # Different port to avoid conflicts with dev
    volumes:
      - ./tests/fixtures/seed-data.sql:/docker-entrypoint-initdb.d/99-seed-data.sql

  redis:
    ports:
      - "6380:6379"  # Different port to avoid conflicts with dev
    command: redis-server --databases 16

  mock-huggingface:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./tests/fixtures:/app/fixtures
      - ./tests/helpers/mock-api-server.js:/app/server.js
    command: node server.js
    ports:
      - "8090:8090"
    environment:
      PORT: "8090"
      FIXTURES_PATH: /app/fixtures/moderation_responses.json

  migrate:
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/civitas_test?sslmode=disable

  gateway:
    ports:
      - "8081:8080"  # Different port for test
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/civitas_test?sslmode=disable
      REDIS_URL: redis://redis:6379/1  # Use DB 1 for tests
      MODERATION_SERVICE_URL: http://moderation:8081
      POLICY_SERVICE_URL: http://policy-engine:8082
      REVIEW_SERVICE_URL: http://review:8083
      PORT: "8080"
      LOG_LEVEL: debug
      ENVIRONMENT: test

  moderation:
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/civitas_test?sslmode=disable
      REDIS_URL: redis://redis:6379/1
      HUGGINGFACE_API_KEY: test-api-key
      HUGGINGFACE_MODEL_URL: http://mock-huggingface:8090/models/test
      PORT: "8081"
      LOG_LEVEL: debug
      ENVIRONMENT: test
    depends_on:
      - mock-huggingface

  policy-engine:
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/civitas_test?sslmode=disable
      REDIS_URL: redis://redis:6379/1
      PORT: "8082"
      LOG_LEVEL: debug
      ENVIRONMENT: test

  review:
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/civitas_test?sslmode=disable
      REDIS_URL: redis://redis:6379/1
      PORT: "8083"
      LOG_LEVEL: debug
      ENVIRONMENT: test

  web:
    ports:
      - "3001:3000"  # Different port for test
    environment:
      VITE_API_URL: http://localhost:8081/api/v1
      NODE_ENV: test
    depends_on:
      - gateway

  # Test runner service for BDD tests
  bdd-tests:
    image: golang:1.22-alpine
    working_dir: /app
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      gateway:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/civitas_test?sslmode=disable
      REDIS_URL: redis://redis:6379/1
      API_URL: http://gateway:8080/api/v1
      TEST_MODE: "true"
    command: ["sh", "-c", "go test -v ./tests/bdd/... -tags=bdd"]
    profiles:
      - test

  # Test runner service for CDD control tests
  cdd-tests:
    image: golang:1.22-alpine
    working_dir: /app
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      TEST_DATABASE_URL: postgres://postgres:postgres@postgres:5432/civitas_test?sslmode=disable
      TEST_REDIS_ADDR: redis:6379
      TEST_MODE: "true"
    command: ["sh", "-c", "go test -v ./tests/cdd/... -tags=cdd"]
    profiles:
      - test

  # E2E Playwright tests
  e2e-tests:
    build:
      context: ./tests/e2e
      dockerfile: Dockerfile.e2e
    depends_on:
      web:
        condition: service_started
      gateway:
        condition: service_healthy
    environment:
      BASE_URL: http://web:3000
      API_URL: http://gateway:8080/api/v1
    volumes:
      - ./tests/e2e:/app
      - ./tests/e2e/playwright-report:/app/playwright-report
      - ./tests/e2e/test-results:/app/test-results
    command: ["npx", "playwright", "test"]
    profiles:
      - test

volumes:
  # No persistent volumes for tests - use ephemeral storage
  pgdata: {}
